static class CountBlocksFn extends DoFn<FileIO.ReadableFile, Long> {
  @ProcessElement
  public void process(@Element FileIO.ReadableFile f, OutputReceiver<Long> out) throws Exception {
    long total = 0L;

    try (InputStream in = Channels.newInputStream(f.open());
         DataFileStream<GenericRecord> dfs =
             new DataFileStream<>(in, new GenericDatumReader<>())) {

      // Iterate blocks until EOF; for each block, add the headerâ€™s record count.
      while (true) {
        try {
          dfs.nextBlock();              // move to next block (throws EOFException at EOF)
          total += dfs.getBlockCount(); // read header field
        } catch (EOFException eof) {
          break;                        // reached end of file
        }
      }
    }

    out.output(total);
  }
}
