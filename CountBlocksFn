static final class CountBlocksFn extends DoFn<FileIO.ReadableFile, Long> {
  @ProcessElement
  public void process(@Element FileIO.ReadableFile f, OutputReceiver<Long> out) throws Exception {
    long total = 0L;

    try (var in = Channels.newInputStream(f.open());
         DataFileStream<GenericRecord> dfs =
             new DataFileStream<>(in, new GenericDatumReader<>())) {

      // Keep moving to next block until we hit EOF
      while (dfs.nextBlock()) {                // âœ… public in DataFileStream
        total += dfs.getBlockCount();          // number of records in this block
      }
    } catch (Exception e) {
      throw new RuntimeException("Failed scanning Avro file: " + f.getMetadata().resourceId(), e);
    }

    out.output(total);
  }
}
